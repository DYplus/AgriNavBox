function residuals = getErr(L, P_GA, R_D)
% GETERR - 计算杆臂投影后的三维空间位置残差
%
% 任务原理: 
%   当驾驶室旋转时，底盘旋转轴中心(接地点)在导航坐标系中的绝对位置应保持不变。
%   投影公式: P_Gp = P_GA - R_D * L_GA
%
% 维度自适应逻辑:
%   1. 若 P_GA 为 Nx3 (包含高度)，则进行完整的三维残差计算。
%   2. 若 P_GA 为 Nx2 (缺失高度)，则使用当前迭代的杆臂高度 L(3) 补齐高度平面，
%      确保 3x3 姿态矩阵 R_D 能够正常进行空间转换，不破坏数学结构。
%
% 输入参数:
%   L     - 1x3 向量: 当前迭代尝试的杆臂值 [dx, dy, dz]
%   P_GA  - Nx2 或 Nx3 矩阵: GNSS天线位置序列 [E, N] 或 [E, N, U]
%   R_D   - 3x3xN 数组: 每一时刻载体到导航坐标系的旋转矩阵
%
% 输出参数:
%   residuals - 列向量: 所有时刻投影点与均值中心点之间的三维偏差 (用于 lsqnonlin)

    N = size(P_GA, 1);
    P_GA_3D = zeros(N, 3);

    % --- 维度检测与自动补齐 ---
    if size(P_GA, 2) == 3
        % 情况1: 包含高度数据，直接使用
        P_GA_3D = P_GA;
    else
        % 情况2: 缺失高度数据，使用当前杆臂高度 L(3) 作为假设的高度基准
        % 这样做可以保证在计算 P_GA - R_D * L 时维度匹配，且利用了姿态信息
        P_GA_3D(:, 1:2) = P_GA;
        P_GA_3D(:, 3) = L(3); 
    end

    % --- 投影计算 ---
    P_Gp = zeros(N, 3);
    for k = 1:N
        % 核心转换公式: 接地点坐标 = 天线坐标 - 旋转矩阵 * 杆臂向量
        % P_Gp(k,:) = P_GA_k - R_D_k * L'
        P_Gp(k, :) = (P_GA_3D(k, :)' - R_D(:, :, k) * L')';
    end

    % --- 计算残差 ---
    % 计算投影点集的质心 (理论上旋转中心点是不动的)
    P_mean = mean(P_Gp, 1);
    
    % 残差 = 每一个瞬时投影点 - 投影点均值
    % 优化器的目标是让所有投影点尽可能重合在均值点上
    err_xyz = P_Gp - P_mean; 
    
    % 将 Nx3 矩阵拉伸为列向量，符合 MATLAB lsqnonlin 的标准要求
    residuals = err_xyz(:); 
end

